---
description: Контекст проекта rhs_player — обзор, стек, фичи, ключевые файлы
alwaysApply: true
---

# rhs_player — контекст проекта

Flutter-плагин видеоплеера только для **Android**. Движок: нативный **ExoPlayer** (androidx.media3), сетевой стриминг. Форк tha_player без iOS.

## Стек

- **Flutter (Dart)** — публичный API, RhsPlayerController, RhsPlayerView
- **Android (Kotlin)** — ExoPlayer, PlatformView, MethodChannel/EventChannel
- **Зависимости:** rxdart (BehaviorSubject), flutter_screenutil (example)

## Фичи

- **Воспроизведение:** play/pause/seek/speed, repeat, BoxFit, плейлисты
- **Треки:** выбор качества видео, аудиодорожек, субтитров (auto/manual)
- **DRM:** Widevine, ClearKey с кастомными headers
- **Надежность:** retry с экспоненциальной задержкой, автоматическая буферизация
- **Android TV:** фокус-навигация D-pad, визуальное выделение, мышь + пульт одновременно (детали: README.md)
- **Превью:** VTT миниатюры, буферизация на прогресс-баре

## Сборка и запуск

**Команды всегда с префиксом `fvm`** (см. [flutter-plugin-standards.mdc](flutter-plugin-standards.mdc)):

```bash
# Из корня проекта
fvm flutter pub get
fvm dart format .

# Запуск примера
cd example && fvm flutter run

# Тесты
fvm flutter test
```

**Тестирование:** DRM на эмуляторе может не работать. Для теста без DRM: `https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4`

## Документация и примеры

- **README.md** — полная документация API (RU)
- **AGENTS.md** — критические архитектурные правила для AI
- **Пример использования:**
  - `example/lib/pages/player/player_page.dart` — интеграция плеера
  - `example/lib/features/player/ui/player_view.dart` — PlayerView + VideoControls
  - `example/lib/main.dart` — настройка приложения

## Ключевые файлы

### Плагин (lib/)

- `lib/rhs_player.dart` — публичный API (экспорты)
- `lib/src/player/player_controller.dart` — RhsPlayerController (play/pause/seek/tracks/streams)
- `lib/src/player/player_view.dart` — RhsPlayerView (PlatformView wrapper)
- `lib/src/media/media_source.dart` — RhsMediaSource (URL, headers, DRM)
- `lib/src/playback/playback_state.dart`, `playback_events.dart` — состояния и события
- `lib/src/tracks/track_models.dart`, `track_events.dart` — модели треков

### Нативный код (android/)

- `android/src/main/kotlin/com/example/rhs_player/` — ExoPlayer интеграция
- `RhsPlayerPlugin.kt` — регистрация PlatformView
- `RhsPlayerPlatformView.kt` — главный view с ExoPlayer
- `RhsPlayerViewFactory.kt` — фабрика для создания view

### Пример (example/lib/)

- `example/lib/features/player/ui/controls/` — система контролов (детали: [player-controls-structure.mdc](player-controls-structure.mdc))
- `example/lib/features/player/ui/controls/README.md` — подробная документация контролов
- `example/lib/features/player/model/player_state.dart` — управление состоянием плеера

## Стиль кода

Следовать `flutter_lints` + [flutter-plugin-standards.mdc](flutter-plugin-standards.mdc). После правок: `fvm dart format .`
